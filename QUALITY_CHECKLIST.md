# OpenImageIO 品質チェックリスト

このドキュメントは、OpenImageIOの品質を担保するためのチェック項目を定義します。

---

## 1. 機能的正確性 (Functional Correctness)

### 1.1 エンコーダー検証

| チェック項目 | PNG | JPEG | GIF | BMP | TIFF | WebP |
|------------|-----|------|-----|-----|------|------|
| 有効なヘッダー/シグネチャ生成 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 正しいメタデータ埋め込み | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 圧縮データが仕様準拠 | ✅ | ✅ | ✅ | - | - | ✅ |
| 適切なチェックサム計算 | ✅ | - | - | - | - | - |

### 1.2 デコーダー検証

| チェック項目 | PNG | JPEG | GIF | BMP | TIFF | WebP |
|------------|-----|------|-----|-----|------|------|
| シグネチャ検証 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 全カラータイプ対応 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 不正データでnil返却 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| チェックサム検証 | ✅ | - | - | - | - | - |

---

## 2. ラウンドトリップ整合性 (Roundtrip Integrity)

### 2.1 ロスレスフォーマット

| フォーマット | 寸法保持 | ピクセル完全一致 | アルファ保持 |
|------------|---------|-----------------|-------------|
| PNG | ✅ 必須 | ✅ 必須 | ✅ 必須 |
| BMP | ✅ 必須 | ✅ 必須 | ✅ 必須 |
| TIFF | ✅ 必須 | ✅ 必須 | ✅ 必須 |
| WebP (VP8L) | ✅ 必須 | ✅ 必須 | ✅ 必須 |

### 2.2 ロッシーフォーマット

| フォーマット | 寸法保持 | 色の許容誤差 | 備考 |
|------------|---------|------------|------|
| JPEG | ✅ 必須 | ±5以内推奨 | DCT量子化による劣化 |
| GIF | ✅ 必須 | パレット依存 | 256色制限 |
| WebP (VP8) | ✅ 必須 | 品質依存 | DCT量子化による劣化 |

### 2.3 マルチフレーム/マルチページ

| 機能 | GIF | TIFF |
|-----|-----|------|
| フレーム/ページ数保持 | ✅ | ✅ |
| 各フレームの寸法保持 | ✅ | ✅ |
| 遅延時間保持 | ✅ | - |

---

## 3. エッジケース処理 (Edge Case Handling)

### 3.1 画像サイズ

| ケース | 期待動作 | テスト状況 |
|-------|---------|----------|
| 1x1 画像 | 正常処理 | ✅ テスト済 |
| 非正方形 (100x1, 1x100) | 正常処理 | ✅ テスト済 |
| 大きな画像 (4096x4096) | 正常処理 | 要検証 |
| 0x0 または負の値 | nil返却 | ✅ ガード済 |

### 3.2 入力データ

| ケース | 期待動作 | 実装状況 |
|-------|---------|---------|
| 空データ | nil返却 | ✅ |
| 不完全なヘッダー | nil返却 | ✅ |
| 破損した圧縮データ | nil返却 | ✅ |
| 不正なチャンクサイズ | nil返却 | ✅ |

### 3.3 色空間

| ケース | 対応状況 |
|-------|---------|
| グレースケール | ✅ PNG, JPEG |
| グレースケール+アルファ | ✅ PNG |
| RGB | ✅ 全フォーマット |
| RGBA | ✅ PNG, BMP, TIFF, WebP |
| パレット | ✅ PNG, GIF |

---

## 4. API一貫性 (API Consistency)

### 4.1 エンコーダーAPI

```swift
// 標準パターン（推奨）
static func encode(image: CGImage, options: [String: Any]? = nil) -> Data?

// マルチフレーム対応
static func encode(images: [CGImage], options: [String: Any]? = nil) -> Data?
```

| エンコーダー | パターン準拠 | 備考 |
|------------|-------------|------|
| PNGEncoder | ✅ | |
| JPEGEncoder | ✅ | `options`から品質取得 |
| GIFEncoder | ✅ | |
| BMPEncoder | ✅ | |
| TIFFEncoder | ✅ | |
| WebPEncoder | ✅ | |

### 4.2 デコーダーAPI

```swift
// 標準パターン（推奨）
static func decode(data: Data) -> DecodeResult?
```

| デコーダー | パターン準拠 | 備考 |
|-----------|-------------|------|
| PNGDecoder | ✅ | |
| JPEGDecoder | ✅ | |
| GIFDecoder | ✅ | `frameIndex`は設計上の選択（マルチフレーム対応） |
| BMPDecoder | ✅ | |
| TIFFDecoder | ✅ | |
| WebPDecoder | ✅ | |
| VP8Decoder | ✅ | 内部API（WebPDecoderから呼び出し） |

### 4.3 オプションキー

```swift
// 共通オプション
kCGImageDestinationLossyCompressionQuality  // 品質 (0.0-1.0)
"lossless"                                   // ロスレスモード
"preserveAlpha"                              // アルファ保持
```

---

## 5. 仕様準拠 (Specification Compliance)

### 5.1 フォーマット仕様

| フォーマット | 仕様 | 準拠項目 |
|------------|------|---------|
| PNG | ISO/IEC 15948 | IHDR, IDAT, IEND必須チャンク |
| JPEG | ITU-T T.81 | SOI, EOI, DQT, DHT, SOF0, SOS |
| GIF | GIF89a | ヘッダー、LCT/GCT、LZW |
| BMP | Microsoft BMP | BITMAPINFOHEADER, BITMAPV4HEADER |
| TIFF | TIFF 6.0 | IFD構造、必須タグ |
| WebP | Google WebP | RIFF, VP8/VP8L |

### 5.2 マジックバイト検証

| フォーマット | シグネチャ | 検証位置 |
|------------|-----------|---------|
| PNG | `89 50 4E 47 0D 0A 1A 0A` | オフセット0 |
| JPEG | `FF D8 FF` | オフセット0 |
| GIF | `GIF87a` / `GIF89a` | オフセット0 |
| BMP | `BM` | オフセット0 |
| TIFF | `II` / `MM` + `2A 00` | オフセット0 |
| WebP | `RIFF....WEBP` | オフセット0,8 |

---

## 6. エラーハンドリング (Error Handling)

### 6.1 エンコーダー

| 条件 | 期待動作 |
|-----|---------|
| nilイメージ | nil返却 |
| 空イメージ配列 | nil返却 |
| 無効な寸法 | nil返却 |
| データプロバイダーなし | nil返却 |

### 6.2 デコーダー

| 条件 | 期待動作 |
|-----|---------|
| 空データ | nil返却 |
| 無効シグネチャ | nil返却 |
| 不完全ヘッダー | nil返却 |
| 破損圧縮データ | nil返却 |
| ⚠️ プレースホルダー画像禁止 | nil返却のみ許可 |

---

## 7. パフォーマンス (Performance)

### 7.1 メモリ効率

| チェック項目 | 実装状況 |
|------------|---------|
| バッファの事前確保 (`reserveCapacity`) | ✅ |
| 不要なコピーの回避 | ✅ |
| 大きなデータの分割処理 | ✅ |

### 7.2 処理速度

| 操作 | 目標 |
|-----|------|
| 小画像エンコード (100x100) | < 10ms |
| 中画像エンコード (1000x1000) | < 100ms |
| デコード | エンコードより高速 |

---

## 8. セキュリティ (Security)

### 8.1 バッファオーバーフロー防止

| チェック項目 | 実装状況 |
|------------|---------|
| 配列境界チェック | ✅ |
| ポインタアクセス検証 | ✅ |
| サイズオーバーフロー検証 | ✅ |

### 8.2 DoS対策

| チェック項目 | 実装状況 |
|------------|---------|
| 最大画像サイズ制限 | 要検討 |
| 圧縮爆弾対策 | 部分的 |
| 無限ループ防止 | ✅ |

---

## 9. テストカバレッジ目標

### 9.1 必須テスト

| カテゴリ | 目標カバレッジ |
|---------|--------------|
| エンコード基本機能 | 100% |
| デコード基本機能 | 100% |
| ラウンドトリップ | 各フォーマット最低3件 |
| エッジケース | 各フォーマット最低5件 |
| エラーハンドリング | 各フォーマット最低3件 |

### 9.2 現在のテスト数

| テストスイート | テスト数 |
|--------------|---------|
| CGImageDestinationTests | 75 |
| ImageFormatTests | 45 |
| CGImageSourceTests | 42 |
| CGImageMetadataTests | 39 |
| CGImageMetadataTagTests | 30 |
| OpenImageIOTests | 21 |
| CoreFoundationTypesTests | 12 |
| **合計** | **264** |

---

## 10. チェックリスト実行手順

### 新機能追加時

1. [ ] 上記全カテゴリのチェック項目を確認
2. [ ] 対応するユニットテストを追加
3. [ ] ラウンドトリップテストを追加
4. [ ] エッジケーステストを追加
5. [ ] `swift test` が全パス

### リリース前

1. [ ] 全264テストがパス
2. [ ] 各フォーマットのラウンドトリップ確認
3. [ ] 1x1画像テスト確認
4. [ ] エラーハンドリングテスト確認
5. [ ] ドキュメント更新確認

---

*ドキュメント作成日: 2024-12-18*
*最終更新日: 2024-12-18* (JPEGEncoder API統一)
